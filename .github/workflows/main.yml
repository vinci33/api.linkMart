name: todo-ci-cd
on:
  push:
    branches:
      - "production"
  workflow_dispatch:

env:
  TEST__DB_NAME: linkmart
  TEST__DB_USERNAME: hotinglo
  TEST__DB_PASSWORD: 1993
  TEST__DB_HOSTNAME: postgres
  TEST__DB_PORT: 5432

jobs:
  test-and-build-dockerize-server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: corretto
          java-version: 17
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
      - run: |
          ./gradlew clean test bootJar --refresh-dependencies
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }} ask kenneth
          password: ${{ secrets.DOCKERHUB_TOKEN }} ask kenneth
      - name: Docker Build and Push
        run: |
          ls -la
          pwd
          cd 04_JAD/Todolist (the big filename)
          docker build -t jamesteckyio/c28jad:latest . (docker image name)
          docker push jamesteckyio/c28jad:latest  (docker image name)
  # deploy-server:
  #   needs: test-and-build-dockerize-server
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Executing remote ssh
  #       uses: appleboy/ssh-action@master
  #       with:
  #         host: jad.jameslam.me (own domain)
  #         key: ${{ secrets.SSH_PRIVATE_KEY }}
  #         username: ubuntu
  #         script: |
  #           cd docker
  #           sudo docker compose pull
  #           sudo docker compose up -d
  #           sudo docker image prune -f 